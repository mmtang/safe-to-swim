<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
    <meta name="description" content="">
    <meta name="author" content="">
    <title>Safe to Swim Map Demo</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css"
    integrity="sha512-M2wvCLH6DSRazYeZRIm1JnYyh22purTM+FDB5CsyxtQJYeKq83arPe5wgbNmcFXGqiSH2XR8dT/fJISVA1r/zQ=="
    crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"
    integrity="sha512-lInM/apFSqyy1o6s89K4iQUKg6ppXEgsVxT35HbzUupEVRh2Eu9Wdl4tHj7dZO0s1uvplcYGmt3498TtHq+log=="
    crossorigin=""></script>
    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">

    <style>
        html, body, #container {
            height: 100%;
            width: 100%;
            overflow: hidden;
          }

        body {
            padding-top: 50px;
            font-family: 'Open Sans', sans-serif;
        }

        #sidebar {
            display: none;
            width: 55%;
            height: 100%;
            max-width: 100%;
            float: right;
            border: 1px solid lightgray;
        }

        .panel-heading{
            width: inherit;
        }

        .panel-body{
            width: inherit;
        }
    
        #map {
            width: auto;
            height: 100%;
            box-shadow: 0 0 5px rgba(0,0,0,0);
        }

        #features {
            margin: 0px;
            border: none;
            border-radius: 0px;
            -webkit-box-shadow: none;
                box-shadow: none;
        }

        #feature-title p {
            font-size: 12px;
            color: grey;
            padding-bottom: 0px;
            margin: 2px 0 0 0;
        }

        #sidebar-hide-btn {
            margin-top: -2px;
        }


        #aboutTabsContent {
            padding-top: 10px;
        }

        .graphLabel, .gmLineLabel, .stvLineLabel {
            font-size: 0.8em; 
            font-weight: normal;
        }

        .data-dot {
            color: rgb(51, 91, 150);
        }

        .gMean-dot {
            color: #ED6874;
        }
        
        .modal {
            text-align: center;
            padding: 0!important;
        }

        .modal:before {
            content: '';
            display: inline-block;
            height: 100%;
            vertical-align: middle;
            margin-right: -4px;
        }

        .modal-dialog {
            display: inline-block;
            text-align: left;
            vertical-align: middle;
        }

        .white {
            color: #FFFFFF;
        }

        .feature-row {
            cursor: pointer;
            width: 250px;
        }

        .panel-content-header {
            padding-top: 0px;
            text-align: center;
            border-bottom: 1px solid #e5e5e5;
        }

        #sidebar-control {
            padding: 3px 4px 0px 0px;
        }

        .sidebar-wrapper {
            width: 100%;
            height: 100%;
            position: relative;
            background-color: #fff;
        }

        .sidebar-table {
            position: absolute;
            width: 100%;
            top: 103px;
            bottom: 0px;
            overflow: auto;
        }

        .leaflet-control-layers {
            overflow: auto;
        }

        .leaflet-control-layers label {
            font-weight: normal;
            margin-bottom: 0px;
        }

        .leaflet-control-layers-list input[type="radio"], input[type="checkbox"] {
            margin: 2px;
        }

        .table {
            margin-bottom: 0px;
        }

        .tick text {
            font-size: 11px;
        }

        .navbar-nav > li > a {
            padding-top: 17px;
            padding-bottom: 13px;
        }

        .navbar .navbar-brand {
            font-weight: normal;
            font-size: 20px;
            color: #FFFFFF;
        }

        .navbar-collapse.in {
            overflow-y: hidden;
        }

        .navbar-header .navbar-icon-container {
            margin-right: 15px;
        }

        .navbar-header .navbar-icon {
            line-height: 50px;
            height: 50px;
        }

        .navbar-header a.navbar-icon {
            margin-left: 25px;
        }

        .typeahead {
            background-color: #FFFFFF;
        }

        .tt-dropdown-menu {
            background-color: #FFFFFF;
            border: 1px solid rgba(0, 0, 0, 0.2);
            border-radius: 4px 4px 4px 4px;
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
            margin-top: 4px;
            padding: 4px 0;
            width: 100%;
            max-height: 300px;
            overflow: auto;
        }

        .tt-suggestion {
            font-size: 14px;
            line-height: 20px;
            padding: 3px 10px;
        }

        .tt-suggestion.tt-cursor {
            background-color: #0097CF;
            color: #FFFFFF;
            cursor: pointer;
        }
        
        .tt-suggestion p {
            margin: 0;
        }

        .tt-suggestion + .tt-suggestion {
            border-top: 1px solid #ccc;
        }

        .typeahead-header {
            margin: 0 5px 5px 5px;
            padding: 3px 0;
            border-bottom: 2px solid #333;
        }

        .has-feedback .form-control-feedback {
            position: absolute;
            top: 0;
            right: 0;
            display: block;
            width: 34px;
            height: 34px;
            line-height: 34px;
            text-align: center;
        }

        @media (max-width: 992px) {
            .navbar .navbar-brand {
                font-size: 18px;
                display: none;
            }
        }

        @media (max-width: 767px){
            #sidebar {
                display: none;
        }

        .url-break {
            word-break: break-all;
            word-break: break-word;
            -webkit-hyphens: auto;
            hyphens: auto;
        }

        .dropdown-menu a i{
            color: #FFFFFF;
            }
        }

        .dropdown-menu {
            min-width: 225px;
            padding: 10px;
        }

        /* Popup styling - do not need currently
        .trendMap .leaflet-popup-content-wrapper {
          width: 820px;
          height: 550px;
          background:#ffffff;
          color:#000000;
          font-size:13px;
          line-height:24px;
          font-family: 'Open Sans', sans-serif;
        }
        */
        
        #popupWindow {
            padding-top: 10px;
            padding-bottom: 10px;
            width: 775px;
            height:410px;
        }
    
        .brush .extent {
            stroke: #fff;
            fill-opacity: .125;
            shape-rendering: crispEdges;
            clip-path: url(#clip);
        }
    
        .circles {
            shape-rendering: auto;
        }
    
        .dotContext {
            fill: rgb(51, 91, 150);
            clip-path: url(#clip);
        }
    
        .grid line {
            stroke: lightgrey;
            stroke-opacity: 0.4;
            shape-rendering: crispEdges;
        }
    
        .grid text {
            display: none;
        }
    
        .grid path {
            stroke-width: 0;
        }

        .panel-body {
            padding: 15px ;
        }

        .panel-content-header {
            padding: 0px 15px 15px 15px;
        }
        
        .popupDiv {
            padding: 5px; 
        }
        
        .progress-bar-full {
            width: 100%;
        }

        #sidebar-control {
            display: none;
        }

        .sidebar-wrapper {
            width: 100%;
            height: 100%;
            position: relative;
        }

        .sidebar-table {
            position: absolute;
            width: 100%;
            top: 103px;
            bottom: 0px;
            overflow: auto;
        }

        #siteTextBox {
            background: #f7f4f9;
            padding: .5em;
            border-radius: .5em;
        }
        
        #popupMenu {
            display: flex;
            font-size: 12px;
            justify-content: space-between;
            padding: 2px 0;
            /* border: 1px black solid; */
        }
    
        .panel-body label {
            font-size: 13px; 
            margin: 0;
            font-weight: normal;
            color: dimgray;
        }

        #analyteSelect {
            flex-basis: 25%;
        }

        #filterMenu {
            order: 1;
            flex-basis: auto;
        }
    
        #legendMenu {
            height: 35px; 
            order: 2;
            flex-basis: 25%;
            /* border: 1px black solid; */
        }
    
        .line {
            fill: none;
            stroke: #ad1111;
            shape-rendering: crispEdges;
        }
        
        .yLabel {
            font-size: 11px
        }
    
        .tooltip {
          width: auto;
          height: auto;
          position: absolute;
          text-align: left;
          vertical-align: middle;
          padding: 8px 12px 8px 10px;
          /* white-space: nowrap; */  
          font-size: 11px;
          border-radius: 6px;
          pointer-events: none;
          background-color: #fff;
          border: 1px solid;
        }
    
        rect.pane {
            cursor: move;
            fill: none;
            pointer-events: all;
        }

        #pluswrap {
            display: none;
            position: fixed;
            width: 100%;
            height:100%;
            display: flex;
            align-items: center;
            background: rgba(0, 0, 0, 0.6);
            top: 0;
            z-index: 20000;
            
        }

        .plus {
            display: flex;
            margin: 0 auto;
        }

        .loader,
        .loader:after {
            border-radius: 50%;
            width: 10em;
            height: 10em;
        }

        .loader {
            margin: 60px auto;
            font-size: 10px;
            position: relative;
            text-indent: -9999em;
            border-top: 0.7em solid rgba(255, 255, 255, 0.2);
            border-right: 0.7em solid rgba(255, 255, 255, 0.2);
            border-bottom: 0.7em solid rgba(255, 255, 255, 0.2);
            border-left: 0.7em solid rgba(255, 255, 255, 0.9);
            -webkit-transform: translateZ(0);
            -ms-transform: translateZ(0);
                transform: translateZ(0);
            -webkit-animation: load8 0.9s infinite linear;
                animation: load8 0.9s infinite linear;
        }

        @-webkit-keyframes load8 {
            0% {
                -webkit-transform: rotate(0deg);
                    transform: rotate(0deg);
            }

            100% {
                -webkit-transform: rotate(360deg);
                transform: rotate(360deg);
            }
        }
            
        @keyframes load8 {
            0% {
                -webkit-transform: rotate(0deg);
                transform: rotate(0deg);
            }
            100% {
                -webkit-transform: rotate(360deg);
                transform: rotate(360deg);
            }
        }

    
      </style>
    </head>

    <body>
        <div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
            <div class="container-fluid">
            <div class="navbar-header">
                <div class="navbar-icon-container">
                <a href="#" class="navbar-icon pull-right visible-xs" id="nav-btn"><i class="fa fa-bars fa-lg white"></i></a>
                <a href="#" class="navbar-icon pull-right visible-xs" id="sidebar-toggle-btn"><i class="fa fa-search fa-lg white"></i></a>
                </div>
                <a class="navbar-brand" href="#">Safe to Swim Map Demo</a>
            </div>
            <div class="navbar-collapse collapse">

                <ul class="nav navbar-nav navbar-left">
                        <li class="dropdown">
                            <a class="dropdown-toggle" id="downloadDrop" href="#" role="button" data-toggle="dropdown"><i class="fa fa-list white"></i>&nbsp;&nbsp;Layers <b class="caret"></b></a>
                            <ul class="dropdown-menu">
                                <li><strong>Reference</strong></li>
                                <li><input class="form-check-input" type="checkbox" unchecked>&nbsp;&nbsp;Region Board Boundaries</li>
                                <li><input id="counties-box" class="form-check-input" type="checkbox" unchecked>&nbsp;&nbsp;County Boundaries</li>
                            </ul>
                        </li>
                </ul>
                
                <ul class="nav navbar-nav navbar-right">
                <li><a href="#" data-toggle="collapse" data-target=".navbar-collapse.in" id="about-btn"><i class="fa fa-question-circle white fa-lg"></i></a></li>
                </ul>
            </div><!--/.navbar-collapse -->
            </div>
        </div>
    
        <div id="container">
            <div id="sidebar">
            <div class="sidebar-wrapper">
                <div class="panel panel-default" id="features">
                <div class="panel-heading">
                    <h3 class="panel-title"><button type="button" class="btn btn-xs btn-default pull-left" id="sidebar-hide-btn"><i class="fa fa-chevron-right"></i></button>&nbsp;&nbsp;Site Trends</h3>
                </div>
                <div class="panel-body">
                    <div class="row">
                    <div id="panel-content" class="col-xs-12 col-md-12">
                        <div class="panel-content-header">
                            <h4 class="modal-title text-primary" id="feature-title"></h4>
                        </div>
                        <div id="feature-info" class="panel-body">
                        </div>
                    </div>
                    </div>
                </div>
                </div>
            </div>
            </div>
            <div class="trendMap" id="map"></div>
        </div>
    
        <div class="modal fade" id="aboutModal" tabindex="-1" role="dialog">
            <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                <button class="close" type="button" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title">About the Map</h4>
                </div>
                <div class="modal-body">
                    <div class="tab-pane fade active in" id="about">
                    <p><img style="float: right; padding-left: 10px;" src="assets\img\cwqmc-logo.jpg">Understanding trends allows decision makers to determine whether pollution sources are increasing in magnitude and/or frequency and the effectiveness of control measures.</p>
                    <p>The interactive map below provides sampling results for coastal beach monitoring locations over time. A few county health agencies provide creek and lake information along with ocean beach information. Otherwise, lake and stream information is currently unavailable electronically.</p>
                    <ul>
                        <li>To find bacterial sample results for a particular site, first select the county, then click on a site location. The results will appear to the right of the map. Results may take time to appear.</li>
                        <li>Place your mouse cursor over a point on the chart to see the date and sample result for a particular sample event. </li>
                    </ul>
                    Open source, MIT licensed, and available on <a href="https://github.com/bmcbride/bootleaf" target="_blank">GitHub</a>.</p>
                    </div>
                </div>
            </div><!-- /.modal-content -->
            </div><!-- /.modal-dialog -->
        </div><!-- /.modal -->

        <div id="sidebarArrow">
            <i class="fa fa-question-circle pull-right fa-lg"></i>
        </div>

        <div id="pluswrap">
                <div class="plus">
                        <div class="loader">Loading...</div>
                </div>
        </div>
    
        <div class="modal fade" id="attributionModal" tabindex="-1" role="dialog">
            <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                <button class="close" type="button" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="modal-title">
                    Bootleaf Template: <a href='http://bryanmcbride.com'>bryanmcbride.com</a>
                </h4>
                </div>
                <div class="modal-body">
                <div id="attribution"></div>
                </div>
            </div><!-- /.modal-content -->
            </div><!-- /.modal-dialog -->
        </div><!-- /.modal -->

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
        <script src="https://d3js.org/d3.v4.js"></script>
        <script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.2.0/leaflet-omnivore.min.js'></script>

        <script>

            $("#pluswrap").hide();

            var map = L.map('map',{ 
                center: [37.4050, -119.4179], 
                zoom: 6, 
                preferCanvas: true,
                zoomControl: false
            }); 

            /* For main loading animation
            $(document).one("ajaxStop", function () {
                $("#loading").hide();
                sizeLayerControl();
            });
            */

            $("#about-btn").click(function() {
                $("#aboutModal").modal("show");
                $(".navbar-collapse.in").collapse("hide");
                return false;
            });

            $("#nav-btn").click(function() {
                $(".navbar-collapse").collapse("toggle");
                return false;
            });

            $("#sidebar-toggle-btn").click(function() {
                animateSidebar();
                return false;
            });

            $("#sidebar-hide-btn").click(function() {
                animateSidebar();
                return false;
            });

            function animateSidebar() {
                $("#sidebar").animate({
                    width: "toggle"
                }, 250, function() {
                    map.invalidateSize();
                    showSidebarControl();
                });
            }

            function showSidebar() {
                hideSidebarControl();
                $("#sidebar").show(250, function() {
                    map.invalidateSize();
                });
            }

            function showSidebarControl() {
                document.getElementById("sidebar-control").style.display = "block";
            }

            function hideSidebarControl() {
                document.getElementById("sidebar-control").style.display = "none";
            }

            // Add zoom control
            L.control.zoom({ position:'topleft' }).addTo(map);

            var Esri_WorldTopoMap = L.tileLayer('http://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri'
            }).addTo(map);

            var Esri_WorldImagery = L.tileLayer('http://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri'
            });

            var baseLayers = {
                "Topo": Esri_WorldTopoMap,
                "World Imagery": Esri_WorldImagery
                };

            // Add base layer control
            var layerControl = L.control.layers(baseLayers, null, {collapsed: true, position: 'bottomleft'}).addTo(map);

            // Add sidebar control
            var sidebarControl = L.Control.extend({
                    options: {
                        position: 'topright'
                    },

                onAdd: function (map) {
                    var container = L.DomUtil.create('div', 'sidebar-control-container');
                    container.innerHTML = '<div id="sidebar-control"><a href="#" id="sidebar-show-btn" onClick="showSidebar()"><button type="button" class="btn btn-xs btn-default pull-left" id="sidebar-show-btn"><i class="fa fa-chevron-left fa-lg"></i></button></a></div>';
                    return container;
                }
            });
            
            map.addControl(new sidebarControl());

            var defaultMarker = {
                radius: 5,
                fillColor: "#008080",
                color: "#fff",
                weight: 1,
                opacity: 1,
                fillOpacity: 0.8
            };

            var selectedMarker = {
                radius: 4,
                fillColor: "#40e0d0",
                color: "#40e0d0",
                weight: 2,
                opacity: 1,
                fillOpacity: 0.8
            };
        
            // For using Leaflet's JSON
            // var siteData = "input/DistinctStations.geojson";

            var siteLayer = L.geoJSON(null, {
                pointToLayer: function (feature, latlng) {
                    return L.circleMarker(latlng, defaultMarker);
            },
                onEachFeature: function (feature, layer) {

                        if (feature.properties) {
                            layer.on({
                                click: function (e) {
                                    $("#feature-title").html(feature.properties.StationName + "<p>Station Code: " + feature.properties.StationCode + "</p>");
                                }
                            })
                        }
                } // onEachFeature
            }).addTo(map); // L.geoJson

            
            // Load site data
            omnivore.csv('input/UniqueStations.csv', null, siteLayer).addTo(map);

            

            function clearGraph() {
                d3.selectAll(".axis grid").remove();
                d3.selectAll(".circles").remove();
                d3.selectAll(".gCircles").remove();
                d3.selectAll('.line').remove();
                d3.selectAll(".xAxis").remove();
                d3.selectAll('.yAxis').remove();
                d3.selectAll('.xLabel').remove();
                d3.selectAll('.yLabel').remove();
                d3.selectAll('.axis').remove();
                d3.selectAll('.dotContext').remove();
                d3.selectAll('.brush').remove();
                d3.selectAll('.gmLineLabel').remove();
                d3.selectAll('.stvLineLabel').remove();
                d3.selectAll('.svgLegend').remove();
                d3.selectAll('.legend').remove();
                d3.selectAll('.graphLabel').remove();
            }


            // Listener for map click
            siteLayer.on('click', function(e) {
                clearGraph(); 
                hideSidebarControl();
                var currentZoom = map.getZoom();
                if (currentZoom > 12) { 
                    var targetZoom = currentZoom;
                } else {
                    targetZoom = 12;
                }
                var targetZoom = 
                map.setView(e.latlng, targetZoom, { animation: true });  // Zoom to selected site 
                $("#sidebar").show(250, function() {
                    map.invalidateSize(); 
                    onMarkerClick(e);
                });
            });

            function onMarkerClick(e) {

                var siteClicked = e.layer.feature.properties.StationCode;

                // Reset layer style
                siteLayer.setStyle(defaultMarker);
                console.log(e, siteClicked);

                highlightMarker(e);

                function highlightMarker(e) {
                    e.layer.options.color = "#00e5ee";
                    e.layer.options.fillColor = "#00e5ee";
                    e.layer.options.weight = 3;
                }

                var content = '<div id="popupMenu"><div id="analyteMenu"></div><div id="filterMenu"></div></div>' + '<div id="siteGraph"><svg width="862" height="390"></div>';
                $("#feature-info").html(content);
                $("#featureModal").modal("show");
                $("#pluswrap").show();

                var gColor = "#ED6874";

                var ecoli = "E. coli",
                    enterococcus = "Enterococcus",
                    coliformtotal = "Coliform, Total",
                    coliformfecal = "Coliform, Fecal";

                var ecoli_STV = 320,
                    enterococcus_STV = 110,
                    ecoli_GM = 100,
                    enterococcus_GM = 30;

                function createURL(limit) {
                    var baseURL = 'https://data.ca.gov/api/action/datastore/search.jsonp?resource_id=7fe7df64-16b5-4866-b34f-1870a94ee607';
                    return baseURL + '&limit=' + limit + '&filters[StationCode]=' + siteClicked; ;
                }

                // For testing asynchronus recursive call
                var testURL = createURL(1);
                // For synchronus recursive call
                var initialURL = createURL(100);
                console.log("initialURL:", initialURL);


                /**********************************/
                /* Synchronus Recursive API Call */
                /**********************************/

                getRecords(createViz);

                function getRecords(callback, offset, data) {
                    if (typeof offset === 'undefined') { offset = 0; }
                    if (typeof data === 'undefined') { data = []; }

                    $.ajax({
                        type: "GET",
                        url: initialURL,
                        data: {offset: offset},
                        dataType: "jsonp",
                        jsonpCallback: 'createViz',
                        success: function(res) {
                            var dataPage = res.result.records;
                            console.log("total records:", res.result.total); 
                            data = data.concat(dataPage);
                            if (dataPage.length < 100) {
                                console.log("called data", data);
                                callback(data);
                            } else {
                                getRecords(callback, offset + 100, data);
                            }
                        }
                    });
                }
                
                /**********************************/
                /**********************************/

                // Get data and draw graph
                function createViz(data) {

                        $("#pluswrap").hide();

                        var Data = processData(data);

                        function processData(d) {

                            var data = d;
                            // For JSONP API. Parse dates formatted as "2017-09-31 00:00:00"
                            var parseDate = d3.timeParse("%Y-%m-%d %H:%M:%S");
                            // For JSON local file. Parse dates formattted as "09/14/2012 0:00"
                            //  var parseDate = d3.timeParse("%m/%d/%Y %H:%M:%S")

                            // Lists of unique indicators and programs
                            var indicatorSet = new Set(); 

                            data.forEach(function(d) {
                                d.sampleDate = parseDate(d.SampleDate);
                                d.result = +d.Result;
                                d.analyte = d.Analyte;
                                indicatorSet.add(d.analyte);
                                d.resultqualcode = d.ResultQualCode;
                                d.mdl = +d.MDL;
                            });

                            var indicators = [];
                            indicatorSet.forEach(function(v) {
                                indicators.push(v);
                            });

                            // Not compatible IE
                            // var indicators = Array.from(indicatorSet);
                            
                            var defaultAnalyte = indicators[0];
                            console.log("indicators", indicators); 

                            d3.select("#analyteSelect").remove();

                            // Create sidebar menus
                            if (indicators.length > 0) {
                                // Create analyte menu
                                var analyteSelect = document.createElement("select");
                                analyteSelect.id = "analyteSelect";
                                analyteSelect.className = "form-control input-sm";
                                analyteSelect.innerHTML = "";
                                for (var i = 0; i < indicators.length; i++) {
                                    var opt = indicators[i];
                                    analyteSelect.innerHTML += "<option value=\"" + opt + "\">" + opt + "</option>";
                                }
                                var selectDiv = document.getElementById("analyteMenu");
                                selectDiv.appendChild(analyteSelect);

                                // Create filter menu
                                var filterSpace = document.getElementById("filterMenu");
                                var filterContent = '<div id="filterMenu"><div class="form-check"><label><input id="filterData" value="data" class="form-check-input" type="checkbox" checked>&nbsp;Sample data&nbsp;&nbsp;<i class="fa fa-circle data-dot" aria-hidden="true"></i></label></div><div class="form-check"><label><input id="filterGeomean" value="geomean" class="form-check-input" type="checkbox" checked>&nbsp;Geometric mean&nbsp;&nbsp;<i class="fa fa-circle gMean-dot" aria-hidden="true"></i></label></div></div>';
                                filterSpace.innerHTML += filterContent;

                                drawGraph(defaultAnalyte);

                            } else {
                                alert("No data for this site.");
                            }

                            // Listen for analyte change
                            d3.selectAll("select").on("change", function() {
                                    drawGraph(this.value);
                            });

                            function drawGraph(formAnalyte) {

                                clearGraph(); 
                                resetCheckboxes();
                    
                                var div = d3.select("body").append("div")
                                    .attr("class", "tooltip")
                                    .style("opacity", 0);

                                // Filter by analyte
                                var newData = data.filter(function(data) { 
                                    if ((data.StationCode === siteClicked) && (data.analyte === formAnalyte)) { return d; }
                                });

                                // Need to redo checks
                                if (newData.length < 1 ) { window.alert("No data for this indicator."); }

                                newData = newData.sort(function(a, b) { return b.sampleDate - a.sampleDate }); // Sort descending

                                // Get reference dates
                                var lastSampleDate = newData[0].sampleDate,
                                    dataArrayLength = newData.length,
                                    earliestDate = newData[dataArrayLength - 1].sampleDate;

                                var oneDay = (24 * 60 * 60 * 1000);
                                var geomeanDays = 42;   // Offset days: 6 weeks
                                
                                function getGeomeans(data, startDate, endDate, days) {
                                    var geomeansArray = [];
                                    var offsetValue = oneDay * days; 
                                    var refDate = convertDate(startDate);
                                    var stopDate = convertDate(endDate);
                                    while(refDate >= stopDate) {
                                        var newDate = convertUNIX(refDate);
                                        geomeansArray.push(getGeomeanObject(data, newDate, days));
                                        refDate -= oneDay * 7;  // Offset is one week
                                    }
                                    return geomeansArray;
                                }
                                
                                // Calculates the geometric mean for a single 6-week date range
                                function getGeomeanObject(data, startDate, offsetDays) {

                                        function getCutoffDate(date, offsetDays) {
                                            var offsetValue = oneDay * offsetDays;  // oneDay = (24 * 60 * 60 * 1000)
                                            var offsetDate = date.getTime() - offsetValue;
                                            return convertUNIX(offsetDate);
                                        }

                                        // Collects data falling within a single 6-week range
                                        function getSampleArray(data, startDate, cutoffDate) {
                                            if (data.length === 0) {
                                                console.log("No data for geomean range.");
                                                return null;
                                            }
                                            var newData = data;
                                            var dateArray = [];
                                            for (var i = 0; i < newData.length; i++) {
                                                var d = newData[i];
                                                if ((convertDate(d.sampleDate) <= convertDate(startDate)) && (convertDate(d.sampleDate) >= convertDate(cutoffDate))) {
                                                    if (keepData(d)) {
                                                        dateArray.push(d); 
                                                    }
                                                }
                                            };
                                            return dateArray;
                                        }

                                        // Checks whether result is a valid ND (Res Qual Code = "ND" and Result is positive)
                                        function keepData(d) {
                                            if ((d.DataQuality === 0) || (d.DataQuality === 4) || (d.DataQuality === 5)) {
                                                return false;
                                            } else if ((d.resultqualcode === "ND") && (d.result > 0)) {
                                                    return false; 
                                            } else if ((d.resultqualcode === "P") && !(d.result)) {
                                                    return false;
                                            } else {
                                                return true;
                                            }
                                        }

                                        // Takes array and calculates geometric mean
                                        function calculateGeomean(data) {
                                            var arrayLength = data.length;
                                            if (arrayLength <= 0) {
                                                console.log("Geomean: Array is empty.");
                                                return null;
                                            } else {
                                                var product = 1;
                                                data.forEach(function(d) {
                                                    if ((d.resultqualcode === "ND") && (d.mdl > 0)) {
                                                        product *= d.mdl * 0.5;     // Half of MDL
                                                    } else {
                                                        product *= d.result; 
                                                    }
                                                });

                                                var gMean = Math.pow(product, (1 / arrayLength)); // nth root
                                                return gMean;
                                            }
                                        }

                                        var cutoffDate = getCutoffDate(startDate, offsetDays);
                                        // Get sample points for geomean
                                        var geomeanData = getSampleArray(data, startDate, cutoffDate);

                                        // Assembles geomean object for single 6-week range
                                        if (geomeanData.length < 1) { 
                                            var geomeanObject = {beginDate: cutoffDate, endDate: startDate, geomean: null}; // No data
                                        } else if (geomeanData.length < 5) {
                                            var geomeanObject = {beginDate: cutoffDate, endDate: startDate, geomean: "NES"}; // Not enough samples
                                        } else {
                                            var geomean = decimalRound(calculateGeomean(geomeanData), 2);
                                            var geomeanObject = {beginDate: cutoffDate, endDate: startDate, geomean: geomean};
                                        }
                                        return geomeanObject;
                                
                                } // End getGeomeanObject()


                                // Compile array of geomean objects
                                geomeanObjects = getGeomeans(newData, lastSampleDate, earliestDate, geomeanDays);
                                endPoint = geomeanObjects[geomeanObjects.length - 1];

                                // Create endpoint geomean object & add to array
                                geomeanObjects.push({beginDate: null, endDate: earliestDate, geomean: endPoint.geomean});
                                console.log("geomeanObjects", geomeanObjects);


                                // Set graph dimensions
                                var margin = {top: 10, right: 20, bottom: 90, left: 70},
                                    margin2 = {top: 340, right: 20, bottom: 10, left: 70},
                                    width = 862 - margin.left - margin.right,
                                    height = 390 - margin.top - margin.bottom,
                                    height2 = 370 - margin2.top - margin2.bottom;
                                
                                // Set ranges
                                var xScale = d3.scaleTime().range([0, width]),
                                    xScale2 = d3.scaleTime().range([0, width]),
                                    yScale = d3.scaleLinear().range([height, 0]),
                                    yScale2 = d3.scaleLinear().range([height2, 0]);
                            
                                var svg = d3.select("#siteGraph")
                                    .select("svg")
                                        .attr("width", width + margin.left + margin.right)
                                        .attr("height", height + margin.top + margin.bottom)
                                        .attr("class", "graph")
                                        .call(responsive);
                                

                                function responsive(svg) {
                                    // get container + svg aspect ratio
                                    var container = d3.select(svg.node().parentNode),
                                        width = parseInt(svg.style("width")),
                                        height = parseInt(svg.style("height")),
                                        aspect = width / height;

                                    // add viewBox and preserveAspectRatio properties,
                                    // and call resize so that svg resizes on inital page load
                                    svg.attr("viewBox", "0 0 " + width + " " + height)
                                        .attr("perserveAspectRatio", "xMinYMid")
                                        .call(resize);

                                    // to register multiple listeners for same event type, 
                                    // you need to add namespace, i.e., 'click.foo'
                                    // necessary if you call invoke this function for multiple svgs
                                    // api docs: https://github.com/mbostock/d3/wiki/Selections#on
                                    d3.select(window).on("resize." + container.attr("id"), resize);

                                    // get width of container and resize svg to fit it
                                    function resize() {
                                        var targetWidth = parseInt(container.style("width"));
                                        svg.attr("width", targetWidth);
                                        svg.attr("height", Math.round(targetWidth / aspect));
                                    }
                                } // responsive()
                                    

                                var focus = svg.append("g")
                                    .attr("class", "focus")
                                    .attr("transform", "translate(" + margin.left + "," + (margin.top + 10) + ")");
                                
                                var context = svg.append("g")
                                    .attr("class", "context")
                                    .attr("transform", "translate(" + margin2.left + "," + (margin2.top + 10) + ")");

                                context.append("defs").append("clipPath")
                                            .attr("id", "clip")
                                            .attr("fill", gColor)
                                        .append("rect")
                                            .attr("width", width)
                                            .attr("height", height);

                                // Find extent for x-axis
                                var currentExtent = d3.extent(newData, function(d) { return d.sampleDate; });

                                // Buffer x-axis extent so points at end are not cut off
                                var xBufferExtent = bufferExtent(currentExtent, 35);

                                // Find max Y data point
                                var yMax = d3.max(newData, function(d) { return d.result });

                                // Compare threshold values to find max Y for display
                                var displayY = compareThresholds(yMax);

                                xScale.domain(xBufferExtent);
                                yScale.domain([0, Math.ceil(roundHundred(displayY + (displayY / 3)))]); // Add buffer to top
                                xScale2.domain(xScale.domain());
                                yScale2.domain(yScale.domain());

                                // Preferred number of ticks 
                                var ticksN = 8;

                                // Define axes
                                var yAxis = d3.axisLeft(yScale)
                                    .tickSize(0)
                                    .tickPadding(10);
                                var xAxis = d3.axisBottom(xScale)
                                    .ticks(ticksN)
                                    .tickSize(0)
                                    .tickPadding(10);
                                var xAxis2 = d3.axisBottom(xScale2)
                                    .ticks(ticksN)
                                    .tickSizeOuter(0);

                                // Define gridlines
                                var xgAxis = d3.axisBottom(xScale)
                                    .ticks(ticksN)
                                    .tickSize(-height);
                                var ygAxis = d3.axisLeft(yScale)
                                    .tickSize(-width);

                                var brush = d3.brushX()
                                    .extent([[0, 0], [width, height2]])
                                    .on("brush", brushed)
                                    .on('end', function() {
                                        var s = d3.event.selection;
                                    });
                                
                                // Add x gridlines to main chart
                                focus.append("g")
                                    .attr("class", "axis grid")
                                    .attr("transform", "translate(0," + height + ")")
                                    .call(xgAxis);

                                // Add y gridlines to mainchart
                                focus.append("g")
                                    .attr("class", "axis grid")
                                    .call(ygAxis);

                                // Add x-axis to main chart
                                focus.append("g")
                                    .attr("class", "xAxis")
                                    .attr("transform", "translate(0," + height + ")")
                                    .call(xAxis);
                                    
                                // Add y-axis to main chart
                                focus.append("g")
                                    .attr("class", "yAxis")
                                    .call(yAxis);
                    
                                // Add y-axis label to main chart  
                                focus.append("text")
                                    .attr("transform", "rotate(-90)")
                                    .attr("y", 0 - 70)
                                    .attr("x", 0 - (height / 2))
                                    .attr("dy", "1em")
                                    .style("text-anchor", "middle")
                                    .text("cfu / 100 ml")
                                    .attr("class", "graphLabel");
                                
                                /*
                                // Define geomean line ** Not using
                                var geomeanLine = d3.line()
                                    .x(function(d) { return xScale(d.endDate); })
                                    .y(function(d) { return yScale(d.geomean); });

                                // Define geomean line for context chart ** Not using
                                var geomeanLineContext = d3.line()
                                    .x(function(d) { return xScale2(d.endDate); })
                                    .y(function(d) { return yScale2(d.geomean); });
                                */

                                var gCircleOpacity = 1;
                                var circleOpacity = 0.7;
                                var tooltipOpacity = 1;
                                var lineOpacity = 1;

                                // Add STV threshold lines: to-do: create class
                                switch (formAnalyte) {
                                    case ecoli:
                                        var geomeanThreshold = focus.append('line')
                                            .attr("class", "line")
                                            .style('stroke', "rgb(51, 91, 150)")
                                            .style('stroke-width', 2)
                                            .style('opacity', lineOpacity)
                                            .attr('x1', 0)
                                            .attr('y1', yScale(ecoli_STV))
                                            .attr('x2', width)
                                            .attr('y2', yScale(ecoli_STV));
                                        focus.append("text")
                                            .attr("transform", "translate(" + (width - 105) + "," + (yScale(ecoli_STV) - 10) + ")")
                                            .attr("dy", ".35em")
                                            .attr("class","stvLineLabel")
                                            .attr("id", "stvLineLabel")
                                            .attr("text-anchor", "start")
                                            .style("fill", "rgb(51, 91, 150)")
                                            .text("STV: " + ecoli_STV + " cfu/100 mL");
                                        break;
                                    case enterococcus:
                                        var geomeanThreshold = focus.append('line')
                                            .attr("class", "line")
                                            .style('stroke', "rgb(51, 91, 150)")
                                            .style('stroke-width', 2)
                                            .style('opacity', lineOpacity)
                                            .attr('x1', 0)
                                            .attr('y1', yScale(enterococcus_STV))
                                            .attr('x2', width)
                                            .attr('y2', yScale(enterococcus_STV));
                                        focus.append("text")
                                            .attr("transform", "translate(" + (width - 105) + "," + (yScale(enterococcus_STV) - 10) + ")")
                                            .attr("dy", ".35em")
                                            .attr("class","stvLineLabel")
                                            .attr("id", "stvLineLabel")
                                            .attr("text-anchor", "start")
                                            .style("fill", "rgb(51, 91, 150)")
                                            .text("STV: " + enterococcus_STV + " cfu/100 mL");
                                        break;
                                }

                                // Add geomean threshold lines
                                switch (formAnalyte) {
                                    case ecoli:
                                        var stvThreshold = focus.append('line')
                                            .attr("class", "line")
                                            .style('stroke', gColor)
                                            .style('stroke-width', 2)
                                            .style('opacity', lineOpacity)
                                            .attr('x1', 0)
                                            .attr('y1', yScale(ecoli_GM))
                                            .attr('x2', width)
                                            .attr('y2', yScale(ecoli_GM));
                                        focus.append("text")
                                            .attr("transform", "translate(" + (width - 105) + "," + (yScale(ecoli_GM) - 10) + ")")
                                            .attr("dy", ".35em")
                                            .attr("class","gmLineLabel")
                                            .attr("id", "gmLineLabel")
                                            .attr("text-anchor", "start")
                                            .style("fill", gColor)
                                            .text("GM: " + ecoli_GM + " cfu/100 mL");
                                        break;
                                    case enterococcus:
                                        var stvThreshold = focus.append('line')
                                            .attr("class", "line")
                                            .style('stroke', gColor)
                                            .style('stroke-width', 2)
                                            .style('opacity', lineOpacity)
                                            .attr('x1', 0)
                                            .attr('y1', yScale(enterococcus_GM))
                                            .attr('x2', width)
                                            .attr('y2', yScale(enterococcus_GM));
                                        focus.append("text")
                                            .attr("transform", "translate(" + (width - 98) + "," + (yScale(enterococcus_GM) - 10) + ")")
                                            .attr("dy", ".35em")
                                            .attr("class","gmLineLabel")
                                            .attr("id", "gmLineLabel")
                                            .attr("text-anchor", "start")
                                            .style("fill", gColor)
                                            .text("GM: " + enterococcus_GM + " cfu/100 mL");
                                        break;
                                }

       

                                // Move line labels if overlapping
                                if ((formAnalyte === enterococcus) || (formAnalyte === ecoli)) {

                                    var gThresholdLabel = document.getElementById("gmLineLabel"),
                                        stvThresholdLabel = document.getElementById("stvLineLabel");
                                    
                                    if (intersect(gThresholdLabel, stvThresholdLabel)) {
                                        d3.select("#stvLineLabel").attr("dy", "-8");;
                                    }
                                }

                                function getPositions(elem) {
                                    var clientRect = elem.getBoundingClientRect();
                                    return [
                                        [ clientRect.left, clientRect.left + clientRect.width ],
                                        [ clientRect.top, clientRect.top + clientRect.height ]
                                    ];
                                }

                                function intersect(elemA, elemB) {
                                    var posA = getPositions(elemA),
                                        posB = getPositions(elemB),
                                        isOverlap = false;

                                    if (posA[0][0] < posB[0][1] && posA[0][1] > posB[0][0] &&
                                        posA[1][0] < posB[1][1] && posA[1][1] > posB[1][0])
                                        isOverlap = true;

                                    return isOverlap;
                                }

                                // Add sample data to main chart area; to-do: create class
                                var dots = focus.append("g");
                                    dots.attr("clip-path", "url(#clip)");
                                    dots.selectAll("circle")
                                        .data(newData)
                                        .enter().append("circle")
                                        .attr('class', 'circles')
                                        .attr("r", 6)
                                        .attr("fill", "rgb(51, 91, 150)")
                                        .attr("cx", function(d) { return xScale(d.sampleDate); })
                                        .attr("cy", function(d) { return yScale(d.result); })
                                        .style("opacity", circleOpacity)
                                        .on("mouseover", function(d) {
                                            // Format date value for tooltip
                                            var tooltipDate = d3.timeFormat("%b %e, %Y");
                                            div.transition()
                                                .duration(100)
                                                .style("opacity", tooltipOpacity);
                                            div.html("<strong>Sample Date: </strong>" + tooltipDate(d.sampleDate) + "<br/ >" + "<strong>Program: </strong>" + d.Program + "<br/ >" + "<strong>Result: </strong>" + d.result + " " + d.Unit)
                                                .style("left", (d3.event.pageX) + "px")
                                                .style("top", (d3.event.pageY) + "px");
                                            d3.select(this)
                                                .attr("fill", "#84c0e3");

                                        })
                                        .on("mouseout", function(d) {
                                            div.transition()
                                                .duration(100)
                                                .style("opacity", 0);
                                            d3.select(this)
                                                .attr("fill", "rgb(51, 91, 150)")
                                                .style("opacity", circleOpacity);
                                        });

                                // Add geomean points to main chart
                                var gDots = focus.append("g");
                                    gDots.attr("clip-path", "url(#clip)");
                                    gDots.selectAll("circle")
                                        .data(geomeanObjects)
                                        .enter().append("circle")
                                        .filter(function(d) { return (d.geomean !== null) && (d.geomean != "NES") })  // Strict not version for null
                                        .attr('class', 'gCircles')
                                        .attr("r", 4)
                                        .attr("fill", gColor)
                                        .attr("cx", function(d) { return xScale(d.endDate); })
                                        .attr("cy", function(d) { return yScale(d.geomean); })
                                        .style("opacity", gCircleOpacity)
                                        .on("mouseover", function(d) {
                                            // Format date value for tooltip
                                            var tooltipDate = d3.timeFormat("%b %e, %Y");
                                            div.transition()
                                                .duration(50)
                                                .style("opacity", tooltipOpacity);
                                            div.html("<strong>Date: </strong>" + tooltipDate(d.endDate) + "<br/ ><strong>Geometric Mean: </strong>" + d.geomean)
                                                .style("left", (d3.event.pageX) + "px")
                                                .style("top", (d3.event.pageY) + "px");
                                            d3.select(this)
                                                .attr("fill", "#f2afa4");
                                        })
                                        .on("mouseout", function(d) {
                                            div.transition()
                                                .duration(50)
                                                .style("opacity", 0);
                                            d3.select(this)
                                                .attr("fill", gColor)
                                                .style("opacity", gCircleOpacity);
                                        });


                                // Add x-axis to context chart
                                context.append("g")
                                    .attr("class", "axis axis--x")
                                    .attr("transform", "translate(0," + height2 + ")")
                                    .call(xAxis2);
                                
                                // Add points to context chart 
                                var dots = context.append("g");
                                    dots.attr("clip-path", "url(#clip)");
                                    dots.selectAll("dot")
                                        .data(newData)
                                        .enter().append("circle")
                                        .attr('class', 'dotContext')
                                        .attr("r", 3)
                                        .style("opacity", 0.5)
                                        .attr("cx", function(d) { return xScale2(d.sampleDate); })
                                        .attr("cy", function(d) { return yScale2(d.result); });
                                                                          
                                context.append("g")
                                    .attr("class", "brush")
                                    .call(brush)
                                    .call(brush.move, xScale.range());


                                // Filter listeners
                                d3.select("#filterData").on("change", toggleData);
                                d3.select("#filterGeomean").on("change", toggleGeomean);


                                function toggleData() {
                                    if(d3.select(this).property("checked")){
                                        d3.selectAll(".circles").attr("visibility", "visible");
                                        // d3.selectAll(".stvLine").attr("visibility", "visible");
                                        // d3.selectAll(".stvGraphLabel").attr("visibility", "visible");
                                    } else {
                                        d3.selectAll(".circles").attr("visibility", "hidden");
                                        // d3.selectAll(".stvLine").attr("visibility", "hidden");
                                        // d3.selectAll(".stvGraphLabel").attr("visibility", "hidden");
                                    }			
                                }

                                function toggleGeomean() {
                                    if(d3.select(this).property("checked")){
                                        d3.selectAll(".gCircles").attr("visibility", "visible");
                                        // d3.selectAll(".gLine").attr("visibility", "visible");
                                        // d3.selectAll(".gmGraphLabel").attr("visibility", "visible");
                                    } else {
                                        d3.selectAll(".gCircles").attr("visibility", "hidden");
                                        // d3.selectAll(".gLine").attr("visibility", "hidden");
                                        // d3.selectAll(".gmGraphLabel").attr("visibility", "hidden");
                                    }			
                                }

                                function brushed() {
                                    var s = d3.event.selection || xScale2.range();
                                    var brushWidth = s[1] - s[0];

                                    // Manage on-screen d3 elements when brush is dragged outside extent
                                    if ((brushWidth === 0) || (s[0] >= width)) { 
                                        focus.selectAll(".circles")
                                            .style("opacity", 0);
                                        focus.selectAll(".gCircles")
                                            .style("opacity", 0);
                                        focus.selectAll(".line")
                                            .style("opacity", 0);
                                        focus.selectAll(".graphLabel")
                                            .style("opacity", 0);
                                    } else {
                                        focus.selectAll(".circles")
                                            .style("opacity", circleOpacity);
                                        focus.selectAll(".gCircles")
                                            .style("opacity", gCircleOpacity);
                                        focus.selectAll(".line")
                                            .style("opacity", lineOpacity);
                                        focus.selectAll(".graphLabel")
                                            .style("opacity", lineOpacity);
                                    }

                                    xScale.domain(s.map(xScale2.invert, xScale2));
                                    focus.selectAll(".circles")
                                            .attr("cx", function(d) { return xScale(d.sampleDate); })
                                            .attr("cy", function(d) { return yScale(d.result); });
                                    focus.selectAll(".gCircles")
                                            .attr("cx", function(d) { return xScale(d.endDate); })
                                            .attr("cy", function(d) { return yScale(d.geomean); });
                                    focus.select(".xAxis").call(xAxis);
                                    focus.select(".grid").call(xgAxis);
                                }

                                function bufferExtent(extent, days) {
                                    // Pad min
                                    var extentMin = convertDate(extent[0]);
                                    var newExtentMin = extentMin - (oneDay * days); 
                                    newExtentMin = convertUNIX(newExtentMin);
                                    // Pad max
                                    var extentMax = convertDate(extent[1]);
                                    var newExtentMax = extentMax + (oneDay * days);
                                    newExtentMax = convertUNIX(newExtentMax);
                                    newExtentObject = [newExtentMin, newExtentMax];  // Assemble
                                    return newExtentObject;
                                }

                                function compareThresholds(y) {
                                    var maxThreshold;
                                    // Only compare STV because STV > GM, but add more checks later
                                    if (formAnalyte === ecoli) {
                                        if (y < ecoli_STV) {
                                            maxThreshold = ecoli_STV;
                                        } else if (y > ecoli_STV) {
                                            maxThreshold = y;
                                        } else {
                                            maxThreshold = ecoli_STV
                                        }
                                    } else if (formAnalyte === enterococcus) {
                                        if (y < enterococcus_STV) {
                                            maxThreshold = enterococcus_STV;
                                        } else if (y > enterococcus_STV) {
                                            maxThreshold = y;
                                        } else {
                                            maxThreshold = enterococcus_STV;
                                        }
                                    } else {
                                        return y;
                                    }
                                    return maxThreshold; 
                                }

                                function resetCheckboxes() {
                                    document.getElementById("filterData").checked="true";
                                    document.getElementById("filterGeomean").checked="true";
                                }

                            } // drawGraph()

                        } // processData()

                } // createViz()

            } // onMarkerClick()

        
        function decimalRound(x, n) {
            if (x === null) { return null; }
            return x.toFixed(n);
        }

        function roundHundred(value) {
            return (value / 100) * 100
        }

        // Convert Javascript date to UNIX time
        function convertDate(date) {
            return date.getTime();
        }

        // Convert UNIX time to Javascript date
        function convertUNIX(seconds) {
            return new Date(seconds);
        }

        
        </script>
    </body>